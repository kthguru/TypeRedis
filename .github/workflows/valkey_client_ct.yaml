#
# Copyright 2025-2026 Infradise Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
name: CT

on:
  push:
    branches: [ main ]
    # paths:
    #   - 'example/**/*.dart'
    #   - 'lib/**/*.dart'
    #   - 'test/**/*.dart'
    #   - 'docker-compose-cluster-tls.yaml'
    #   - 'docker-compose-cluster.yaml'
    #   - 'docker-compose-sentinel.yaml'
    #   - 'dart_test.yaml'
    #   - 'pubspec.yaml'
    #   - 'analysis_options.yaml'
    #   - '.github/workflows/valkey_client_ct.yaml'

  # pull_request:

jobs:
  test:
    name: üß™ Test ${{ matrix.engine }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # - engine: redis
          #   image_name: "redis:latest"
          #   binary_name: "redis"
          #   ssl_dir: "redis"
          - engine: valkey
            image_name: "valkey/valkey-bundle:latest"
            binary_name: "valkey"
            ssl_dir: "valkey"

    steps:
      - uses: actions/checkout@v6

      - name: Checkout specific paths (sparse)
        uses: actions/checkout@v6
        with:
          repository: infradise/keyscope
          ref: main
          path: keyscope
          sparse-checkout: |
            bin/keyscope.dart

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      # ----------------------------------------------------------------
      # 1. Generate SSL Certificates
      # ----------------------------------------------------------------
      - name: Generate SSL Certificates
        run: |
          mkdir -p docs/testenv/${{ matrix.ssl_dir }}/tests/tls

          echo "Generating Self-signed certificates..."

          # Generate generic cert for testing
          openssl req -x509 -newkey rsa:4096 \
            -keyout docs/testenv/${{ matrix.ssl_dir }}/tests/tls/${{ matrix.binary_name }}.key \
            -out docs/testenv/${{ matrix.ssl_dir }}/tests/tls/${{ matrix.binary_name }}.crt \
            -days 365 -nodes -subj '/CN=localhost'

          # Fix permissions
          chmod 644 docs/testenv/${{ matrix.ssl_dir }}/tests/tls/*

      # ----------------------------------------------------------------
      # 2. Start Redis/Valkey Environment
      # ----------------------------------------------------------------
      - name: Start Redis/Valkey Environment
        env:
          CI_IMAGE_NAME: ${{ matrix.image_name }}
          CI_BINARY_NAME: ${{ matrix.binary_name }}
          ABS_CERT_PATH: ${{ github.workspace }}/docs/testenv/${{ matrix.test_dir_name }}/tests/tls
        run: |
          echo "Starting Cluster (7001-7006)..."
          docker compose -f docker-compose-cluster.yaml -p ${{ matrix.binary_name }}-cluster-nonssl up -d

          echo "Starting SSL Cluster (7101-7106)..."
          docker compose -f docker-compose-cluster-tls.yaml -p ${{ matrix.binary_name }}-cluster-ssl up -d

          echo "Starting Sentinel (7201-7203)..."
          docker compose -f docker-compose-sentinel.yaml -p ${{ matrix.binary_name }}-sentinel up -d

          echo "Starting Standalone..."
          docker run -d --name standalone-server -p 6379:6379 ${{ matrix.image_name }}

          echo "Starting TLS Server..."
          docker run -d --name tls-server \
            -v $(pwd)/docs/testenv/${{ matrix.ssl_dir }}/tests/tls:/tls \
            -p 6380:6379 \
            ${{ matrix.image_name }} \
            --tls-port 6379 --port 0 \
            --tls-cert-file /tls/${{ matrix.binary_name }}.crt \
            --tls-key-file /tls/${{ matrix.binary_name }}.key \
            --tls-ca-cert-file /tls/${{ matrix.binary_name }}.crt \
            --tls-auth-clients no

          echo "Starting mTLS Server..."
          docker run -d --name mtls-server \
            -v $(pwd)/docs/testenv/${{ matrix.ssl_dir }}/tests/tls:/tls \
            -p 6381:6379 \
            ${{ matrix.image_name }} \
            --tls-port 6379 --port 0 \
            --tls-cert-file /tls/${{ matrix.binary_name }}.crt \
            --tls-key-file /tls/${{ matrix.binary_name }}.key \
            --tls-ca-cert-file /tls/${{ matrix.binary_name }}.crt \
            --tls-auth-clients yes

      # - name: Check Ports
      #   env:
      #     CI_IMAGE_NAME: ${{ matrix.image_name }}
      #     CI_BINARY_NAME: ${{ matrix.binary_name }}
      #   run: |
      #     docker exec -it valkey-master ss -tlnp

      # ----------------------------------------------------------------
      # 3. Healthcheck using Keyscope (Dogfooding)
      # ----------------------------------------------------------------
      - name: Wait for Services (Keyscope CLI)
        run: |
          # Define a helper function for retrying keyscope ping
          check_service() {
            local port=$1
            local name=$2
            echo "Checking $name on port $port..."

            # Retry loop: Run keyscope ping and check if output contains "PONG"
            # Using 'grep' ensures we validate the connection logic inside valkey_client
            for i in {1..15}; do
              # Run keyscope ping and check for PONG in the output
              OUTPUT=$(dart run keyscope/bin/keyscope.dart ping --port $port --silent || true)
              if echo "$OUTPUT" | grep -q "PONG"; then
                echo "‚úÖ $name is ready!"
                return 0
              fi
              echo "‚è≥ Waiting for $name... (Attempt $i/15)"
              sleep 2
            done

            echo "‚ùå Failed to connect to $name on port $port"
            exit 1
          }

          # Check Standalone
          check_service 6379 "Standalone Server"

          # Check Cluster (Check one node, usually enough if cluster-init finished)
          check_service 7001 "Cluster Node 1"

          # check_service 7101 "Cluster Node"

          # 3. Check SSL Container Status (Basic container check)
          # if [ "$(docker inspect -f '{{.State.Running}}' ssl-tls)" = "true" ]; then
          #    echo "‚úÖ SSL Container is running"
          # else
          #    echo "‚ùå SSL Container failed"
          #    docker logs ssl-tls
          #    exit 1
          # fi

          echo "Checking SSL Cluster on port 7101..."
          if [ "$(docker inspect -f '{{.State.Running}}' ${{ matrix.engine }}-cluster-tls-init-1)" = "true" ]; then
             echo "‚úÖ SSL Cluster Init container is running"
          else
             OUTPUT=$(dart run keyscope/bin/keyscope.dart ping --port 7101 --tls $port --insecure --silent || true)
             echo "‚ö†Ô∏è SSL Cluster container check skipped (relying on container status)"
          fi


      # ----------------------------------------------------------------
      # 4. Run Tests
      # ----------------------------------------------------------------

      #
      # local-env: 00:10 +126: All tests passed!
      # gha-env: OK
      #
      # - name: Run Tests (All)
      #   run: dart test

      - name: Run JSON Tests (Standard)
        run: |
          dart test test/valkey_json/test_code.dart

      - name: Run JSON Tests (Enhanced)
        run: |
          dart test test/valkey_json/test_code_for_enhanced_path.dart

      - name: Run SSL Tests (TLS)
        # working-directory: docs/testenv/${{ matrix.test_dir_name }}
        run: |
          cd docs/testenv/${{ matrix.ssl_dir }}
          dart test ../../../test/ssl_connection_test_single_tls.dart

      - name: Run SSL Tests (mTLS)
        # working-directory: docs/testenv/${{ matrix.test_dir_name }}
        run: |
          cd docs/testenv/${{ matrix.ssl_dir }}
          dart test ../../../test/ssl_connection_test_single_mtls.dart

      # TODO: No problem but, for now, comment this until setup(7001) issue is resolved
      - name: Run Additional SSL Tests (Standalone/Cluster)
        # working-directory: docs/testenv/${{ matrix.test_dir_name }}
        run: |
          cd docs/testenv/${{ matrix.ssl_dir }}
          # dart test ../../../test/ssl_connection_test_single_and_cluster.dart

      - name: Run Additional SSL Tests (TLS/mTLS)
        # working-directory: docs/testenv/${{ matrix.test_dir_name }}
        run: |
          cd docs/testenv/${{ matrix.ssl_dir }}
          dart test ../../../test/ssl_connection_test_single_ssl_and_mtls.dart

      - name: Run Database Tests
        run: |
          dart test test/database_selection_test.dart

      - name: Run Replica Read Tests
        run: |
          dart test test/replica_read_test.dart

      # TODO: No problem but, for now, comment this until setup(7001) issue is resolved
      - name: Run Cluster Tests (Sharded)
        run: |
          # dart test test/valkey_cluster_sharded_test.dart

      # TODO: No problem but, for now, comment this until setup(7001) issue is resolved
      - name: Run Cluster Tests (Redirection)
        run: |
          # dart test test/valkey_cluster_redirection_test.dart

      # TODO: No problem but, for now, comment this until setup(7001) issue is resolved
      - name: Run Cluster Tests (Client)
        run: |
          # dart test test/valkey_cluster_client_test.dart

      - name: Run Example Tests
        run: dart test --tags example

      # TODO: It works on Local-env works, but it is not works on GHA-env.
      - name: Run Unit Tests (Exclude Investigates)
        run: dart test --exclude-tags=example,cluster --concurrency=1

      # Alternative approach without dart_test.yaml
      # - name: Run Unit Tests (Exclude SkipTest Examples)
      #   run: |
      #     dart test $(find test -name "*_test.dart" | grep -v -E 'valkey_cluster_client_test|valkey_cluster_redirection_test|valkey_cluster_sharded_test')


      # ----------------------------------------------------------------
      # 5. Teardown
      # ----------------------------------------------------------------
      - name: Teardown
        env:
          CI_IMAGE_NAME: ${{ matrix.image_name }}
          CI_BINARY_NAME: ${{ matrix.binary_name }}
          ABS_CERT_PATH: ${{ github.workspace }}/docs/testenv/${{ matrix.test_dir_name }}/tests/tls
        if: always()
        run: |
          # 1. Stop and remove containers first to release file locks
          docker compose -f docker-compose-cluster.yaml down || true
          docker compose -f docker-compose-cluster-tls.yaml down || true
          docker compose -f docker-compose-sentinel.yaml down || true
          docker stop standalone-server tls-server mtls-server || true
          docker rm -f standalone-server tls-server mtls-server || true

          # 2. Use sudo to remove files created by Docker root user
          sudo rm -rf ${{ github.workspace }}/*